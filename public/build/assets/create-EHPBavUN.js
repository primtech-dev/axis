import{$ as e}from"./jquery-DxCMfk7S.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./jquery-BQXThELV.js";function f(t){return new Promise((n,a)=>{if(document.querySelector(`script[src="${t}"]`))return n();const i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>n(),i.onerror=()=>a(new Error("Failed to load "+t)),document.head.appendChild(i)})}function p(t){if(document.querySelector(`link[href="${t}"]`))return;const n=document.createElement("link");n.rel="stylesheet",n.href=t,document.head.appendChild(n)}let c=null;async function s(){return c||(c=(async()=>(window.jQuery=window.$=e,p("https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"),typeof e().select2!="function"&&await f("https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"),!0))(),c)}async function m(){try{await s();const t=e("#branch_id");if(!t.length||t.data("select2-initialized"))return;const n=t.data("allow-clear")==="false"?!1:t.data("allow-clear")!==!1,a=!!t.data("no-placeholder");t.select2({width:"100%",allowClear:n,placeholder:a?null:t.data("placeholder")||"— Pilih cabang —"}),t.data("select2-initialized",!0)}catch(t){console.warn("initBranchSelect failed",t)}}function u(t){if(!(t&&t.length))return;if(typeof e().select2!="function"){console.warn("Select2 not ready for variant select");return}if(t.data("select2-initialized"))return;const n=window.stockReceiptVariantSearchUrl||"/stock-receipts/variant-search";t.select2({placeholder:"Cari variant (SKU / variant_name / produk)",ajax:{url:n,dataType:"json",delay:250,data:function(a){return{q:a.term||"",branch_id:e("#branch_id").val()||""}},processResults:function(a){return a?Array.isArray(a.results)?{results:a.results}:{results:(a.items||a.variants||[]).map(r=>({id:r.id,text:r.text||r.variant_name||r.sku||`${r.sku||""} ${r.variant_name||""}`.trim(),sku:r.sku,variant_name:r.variant_name}))}:{results:[]}},cache:!0,error:function(a){console.error("Variant search error",a)}},minimumInputLength:1,width:"100%"}),t.data("select2-initialized",!0)}function l(t={}){const n=e("#items-wrapper"),a=document.getElementById("item-row-template").content;n.append(a.cloneNode(!0));const i=n.children().last(),r=i.find(".variant-select");return s().then(()=>u(r)).then(()=>{if(t.variant_id){const o=t.text||t.variant_name||t.sku||t.variant_id,d=new Option(o,t.variant_id,!0,!0);r.append(d).trigger("change")}}).catch(o=>{console.warn("Select2 not available for new row",o)}),i.find(".btnRemoveItem").on("click",function(){i.remove()}),i}function h(){e("#items-wrapper .item-row").each(function(t){const n=e(this);n.find(".variant-select").attr("name",`items[${t}][variant_id]`),n.find(".qty-input").attr("name",`items[${t}][quantity_received]`)})}function w(){const t=e("#items-wrapper .item-row").last();if(!t.length)return l();const n=t.find(".variant-select").val(),a=t.find(".variant-select option:selected").text()||null,i=t.find(".qty-input").val()||1,r=l({variant_id:n,text:a});r&&r.find(".qty-input").val(i)}e(function(){s().then(()=>{m()}).catch(()=>{console.warn("Select2 failed to load; continuing without it")}).finally(()=>{e("#items-wrapper .item-row").length===0&&l(),e("#btnAddItem").on("click",t=>{t.preventDefault(),l()}),e("#btnAddItemCopyLast").on("click",t=>{t.preventDefault(),w()}),e("#branch_id").on("change",function(){e("#items-wrapper .variant-select").each(function(){const t=e(this);t.val(null).trigger("change"),t.data("select2-initialized",!1),s().then(()=>u(t)).catch(()=>{})})}),e("#stockReceiptForm").on("submit",function(t){h();const n=e("#items-wrapper .item-row");if(!n.length)return t.preventDefault(),window.toast&&window.toast.error("Minimal 1 item harus diisi."),!1;let a=!0;if(n.each(function(){const r=e(this).find(".variant-select").val(),o=e(this).find(".qty-input").val();r||(a=!1),(!o||isNaN(o)||parseInt(o)<=0)&&(a=!1)}),!a)return t.preventDefault(),window.toast&&window.toast.error("Periksa kembali variant dan quantity."),!1;const i=e(this).find('button[type="submit"]').first();return i.prop("disabled",!0),i.html('<span class="spinner-border spinner-border-sm me-1"></span> Menyimpan...'),!0})})});window.__stockReceiptDebug={branchOptionsCount:()=>e("#branch_id option").length,isSelect2:()=>typeof e().select2=="function",variantSelects:()=>e(".variant-select").length};
